以前在Three里写碰撞检测的时候就在想可不可以在Cesium也做一个差不多的模拟游戏人物控制的东西，直到最近才有空写。

简而言之，模拟游戏人物控制有以下几个要求：

1. WASD控制人物行走，空格跳跃。
2. 人物的正方向跟随相机，比如按照W向前走的时候移动相机，人物前进的方向也会随之改变。
3. 模拟重力。



下面记录一些开发的时候比较有意思的地方：

与Three不同，Cesium是一个GIS框架，尽可能的模拟了真实世界。所以Cesium中的坐标系统处理起来比Three麻烦的多，好在Cesium本身的transform足够优秀，省去了很多麻烦。

Cesium内部使用Cartesian3(笛卡尔坐标系)作为运算标准，它是一个以地球球心为原点的三维直角坐标系，同时兼容了经纬度等的转换。

于是我们迎来了第一个问题：如何控制人物在地球表面上行走？

这是一个有趣的地方，因为Cesium中的地球是一个标准的WGS84球体，所以我们需要找到使人物一直贴合这个球体的方法。所幸的是Cesium已经提供了这个方法: *Cesium.Transforms.eastNorthUpToFixedFrame* 。假设我们有一个坐标系Axis1(ENU)，它原点在地球表面上，并且XY面与地球表面相切、Z轴与地面垂直，第二个坐标系Axis2为世界坐标系。*eastNorthUpToFixedFrame* 可以提供一个 Axis1 到 Axis2 的坐标系转化矩阵，即物体坐标系到世界坐标系的桥梁。这样我们就完成了第一小步：通过经纬度等让人物贴合地面移动。

而我们得到的Axis1这个坐标系的意义远不止贴合地面这一点，通过相机当前的heading（以正北为轴的偏移角），我们可以直接拿到物体坐标系的旋转矩阵。同理，通过监听WASD我们拿到了物体坐标系的平移矩阵。

最后三个矩阵相乘得出最终的矩阵，在每一帧里得到正确的转换后的物体坐标系赋予了人物模型沿地表移动和转向的能力。

过了一段时间后我想添加跳跃功能，于是稍微修改了一下代码。我利用动能公式做了一个简单的重力模拟，赋予人物模型一个固定的质量和初动能，通过Cesium内置的时间轴来计算出当前模型应该处于的高度。在做的时候出现了一点小问题，我的方法是在每一帧调用的，所算的结果也是离散的，所以会出现人物下坠到地面的情况。最终在Z为负值的情况下我把高度调整为0作为纠错。



所有的内容差不多就这样，主要注意坐标系之间的转换就好了。



